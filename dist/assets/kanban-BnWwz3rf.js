import{r as e,j as a}from"./vendor-react-r6j4PRy1.js";import{A as l}from"./chat-uWDu6BQy.js";import"./vendor-date-DJxzBke1.js";const s=window.location.origin;function o({onClose:l,onLeadCreated:o}){const[t,n]=e.useState({telefone:"",nome:"",email:"",status:"novo",observacoes:""}),[i,r]=e.useState(!1),[d,c]=e.useState(""),u=e=>{const{name:a,value:l}=e.target;n(e=>({...e,[a]:l})),c("")};return a.jsx("div",{className:"modal-overlay",onClick:l,children:a.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsx("h2",{children:"Adicionar Novo Lead"}),a.jsx("button",{className:"close-button",onClick:l,children:a.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",children:a.jsx("path",{fill:"currentColor",d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]}),a.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),t.telefone.trim())if(t.nome.trim()){r(!0);try{const e=await fetch(`${s}/api/leads`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({telefone:t.telefone.trim(),nome:t.nome.trim(),email:t.email.trim()||null,status:t.status,observacoes:t.observacoes.trim()||""})});if(e.ok){const a=await e.json();o(a),l()}else{const a=await e.json();c(a.error||"Erro ao criar lead")}}catch(a){c("Erro ao criar lead. Tente novamente.")}finally{r(!1)}}else c("Nome é obrigatório");else c("Telefone é obrigatório")},className:"modal-form",children:[a.jsxs("div",{className:"form-group",children:[a.jsxs("label",{htmlFor:"telefone",children:["Telefone ",a.jsx("span",{className:"required",children:"*"})]}),a.jsx("input",{type:"tel",id:"telefone",name:"telefone",value:t.telefone,onChange:u,placeholder:"Ex: 5511999999999",disabled:i,autoFocus:!0}),a.jsx("small",{className:"form-hint",children:"Formato: código do país + DDD + número (sem espaços ou caracteres especiais)"})]}),a.jsxs("div",{className:"form-group",children:[a.jsxs("label",{htmlFor:"nome",children:["Nome ",a.jsx("span",{className:"required",children:"*"})]}),a.jsx("input",{type:"text",id:"nome",name:"nome",value:t.nome,onChange:u,placeholder:"Nome do lead",disabled:i})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"email",children:"Email"}),a.jsx("input",{type:"email",id:"email",name:"email",value:t.email,onChange:u,placeholder:"email@exemplo.com",disabled:i})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"status",children:"Status Inicial"}),a.jsxs("select",{id:"status",name:"status",value:t.status,onChange:u,disabled:i,children:[a.jsx("option",{value:"novo",children:"Novo"}),a.jsx("option",{value:"agendado",children:"Agendado"}),a.jsx("option",{value:"compareceu",children:"Compareceu"}),a.jsx("option",{value:"nao_compareceu",children:"Não compareceu"}),a.jsx("option",{value:"servico_finalizado",children:"Serviço finalizado"}),a.jsx("option",{value:"fechado",children:"Fechado"}),a.jsx("option",{value:"perdido",children:"Perdido"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"observacoes",children:"Observações / Comentários"}),a.jsx("textarea",{id:"observacoes",name:"observacoes",value:t.observacoes,onChange:u,placeholder:"Adicione observações, anotações ou comentários sobre este lead...",rows:"4",disabled:i})]}),d&&a.jsx("div",{className:"error-message",children:d}),a.jsxs("div",{className:"modal-actions",children:[a.jsx("button",{type:"button",className:"button button-secondary",onClick:l,disabled:i,children:"Cancelar"}),a.jsx("button",{type:"submit",className:"button button-primary",disabled:i,children:i?"Criando...":"Criar Lead"})]})]})]})})}const t=window.location.origin;function n({lead:l,onClose:s,onLeadUpdated:o,onLeadDeleted:n}){const[i,r]=e.useState({nome:"",telefone:"",email:"",status:"novo",observacoes:""}),[d,c]=e.useState(!1),[u,h]=e.useState("");e.useEffect(()=>{l&&r({nome:l.nome||"",telefone:l.telefone||"",email:l.email||"",status:l.status||"novo",observacoes:l.observacoes||""})},[l]);return a.jsx("div",{className:"modal-overlay",onClick:s,children:a.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"modal-header",children:[a.jsx("h2",{children:"Editar Lead"}),a.jsx("button",{className:"modal-close",onClick:s,children:a.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",children:a.jsx("path",{fill:"currentColor",d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]}),a.jsxs("form",{onSubmit:async e=>{e.preventDefault(),h("");const a=i.nome&&i.nome.trim().length>0,s=i.telefone&&i.telefone.trim().length>0;if(a&&s){c(!0);try{const e=l.uuid||l.telefone,a=await fetch(`${t}/api/leads/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(a.ok){const e=await a.json();o(e)}else{const e=await a.json();h(e.error||"Erro ao atualizar lead")}}catch(n){h("Erro ao atualizar lead")}finally{c(!1)}}else h("Nome e telefone são obrigatórios")},className:"modal-form",children:[u&&a.jsx("div",{className:"error-message",children:u}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"nome",children:"Nome *"}),a.jsx("input",{type:"text",id:"nome",value:i.nome,onChange:e=>r({...i,nome:e.target.value}),placeholder:"Nome completo",required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"telefone",children:"Telefone *"}),a.jsx("input",{type:"tel",id:"telefone",value:i.telefone,onChange:e=>r({...i,telefone:e.target.value}),placeholder:"+55 11 99999-9999",required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"email",children:"Email"}),a.jsx("input",{type:"email",id:"email",value:i.email,onChange:e=>r({...i,email:e.target.value}),placeholder:"email@example.com"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"status",children:"Status"}),a.jsxs("select",{id:"status",value:i.status,onChange:e=>r({...i,status:e.target.value}),children:[a.jsx("option",{value:"novo",children:"Novo"}),a.jsx("option",{value:"agendado",children:"Agendado"}),a.jsx("option",{value:"compareceu",children:"Compareceu"}),a.jsx("option",{value:"nao_compareceu",children:"Não compareceu"}),a.jsx("option",{value:"servico_finalizado",children:"Serviço finalizado"}),a.jsx("option",{value:"fechado",children:"Fechado"}),a.jsx("option",{value:"perdido",children:"Perdido"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"observacoes",children:"Observações / Comentários"}),a.jsx("textarea",{id:"observacoes",value:i.observacoes,onChange:e=>r({...i,observacoes:e.target.value}),placeholder:"Adicione observações, anotações ou comentários sobre este lead...",rows:"4"})]}),a.jsxs("div",{className:"modal-actions",children:[a.jsxs("button",{type:"button",className:"btn-delete",onClick:async()=>{if(confirm("Tem certeza que deseja excluir este lead?")){c(!0);try{const e=l.uuid||l.telefone,a=await fetch(`${t}/api/leads/${e}`,{method:"DELETE"});if(a.ok)n(l);else{const e=await a.json();h(e.error||"Erro ao excluir lead")}}catch(e){h("Erro ao excluir lead")}finally{c(!1)}}},disabled:d,children:[a.jsx("svg",{viewBox:"0 0 24 24",width:"18",height:"18",children:a.jsx("path",{fill:"currentColor",d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})}),"Excluir"]}),a.jsxs("div",{className:"modal-actions-right",children:[a.jsx("button",{type:"button",className:"btn-cancel",onClick:s,disabled:d,children:"Cancelar"}),a.jsx("button",{type:"submit",className:"btn-submit",disabled:d,children:d?"Salvando...":"Salvar"})]})]})]})]})})}const i=[{id:"novo",title:"Novo",colorVar:"--kanban-novo"},{id:"agendado",title:"Agendado",colorVar:"--kanban-agendado"},{id:"compareceu",title:"Compareceu",colorVar:"--kanban-compareceu"},{id:"nao_compareceu",title:"Não compareceu",colorVar:"--kanban-nao-compareceu"},{id:"servico_finalizado",title:"Serviço finalizado",colorVar:"--kanban-servico-finalizado"},{id:"fechado",title:"Fechado",colorVar:"--kanban-fechado"},{id:"perdido",title:"Perdido",colorVar:"--kanban-perdido"}];const r=e.memo(function({socket:s}){const[t,r]=e.useState([]),[d,c]=e.useState(!0),[u,h]=e.useState(null),[m,v]=e.useState(!1),[x,j]=e.useState(!1),[f,p]=e.useState(null),[b,g]=e.useState(null),[C,N]=e.useState(null),[L,w]=e.useState(!1),[k,y]=e.useState(null),[V,A]=e.useState(null),S=e.useCallback(async()=>{try{const e=await fetch(`${l}/api/leads`),a=await e.json();r(a),c(!1)}catch(e){c(!1)}},[]),H=e.useCallback(e=>{r(a=>a.map(a=>a.uuid===e.uuid?e:a))},[]),E=e.useCallback(e=>{r(a=>[e,...a])},[]),M=e.useCallback(({uuid:e})=>{r(a=>a.filter(a=>a.uuid!==e))},[]);e.useEffect(()=>{if(S(),s)return s.on("lead-updated",H),s.on("lead-created",E),s.on("lead-deleted",M),()=>{s.off("lead-updated",H),s.off("lead-created",E),s.off("lead-deleted",M)}},[s,S,H,E,M]);const T=e.useCallback((e,a)=>{h(a),e.dataTransfer.effectAllowed="move"},[]),$=e.useCallback(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},[]),F=e.useCallback(async(e,a)=>{if(e.preventDefault(),!u||u.status===a)return void h(null);const s=u.uuid||u.telefone;if(!s)return alert("Erro: Lead sem identificador válido"),void h(null);try{const e=await fetch(`${l}/api/leads/${s}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:a})});if(e.ok){const a=await e.json();r(e=>e.map(e=>(e.uuid||e.telefone)===(a.uuid||a.telefone)?a:e))}else{const a=await e.json();alert(`Erro ao atualizar lead: ${a.error||"Erro desconhecido"}`)}}catch(o){alert(`Erro ao atualizar lead: ${o.message}`)}h(null)},[u]),z=e.useCallback((e,a)=>{const l=e.touches[0];g(l.clientY),N(l.clientX),h(a),w(!1)},[]),D=e.useCallback(e=>{if(!u||null===b)return;const a=e.touches[0],l=Math.abs(a.clientY-b),s=Math.abs(a.clientX-C);(l>10||s>10)&&(w(!0),y(a.clientX),A(a.clientY),e.preventDefault())},[u,b,C]),B=e.useCallback(async e=>{if(!u||!L)return h(null),w(!1),g(null),N(null),y(null),void A(null);const a=document.querySelectorAll(".kanban-column");let s=null;if(a.forEach(e=>{const a=e.getBoundingClientRect();k>=a.left&&k<=a.right&&V>=a.top&&V<=a.bottom&&(s=e)}),!s)return h(null),w(!1),g(null),N(null),y(null),void A(null);const o=s.getAttribute("data-status");if(u.status===o)return h(null),w(!1),g(null),N(null),y(null),void A(null);const t=u.uuid||u.telefone;if(!t)return alert("Erro: Lead sem identificador válido"),h(null),w(!1),g(null),N(null),y(null),void A(null);try{const e=await fetch(`${l}/api/leads/${t}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:o})});if(e.ok){const a=await e.json();r(e=>e.map(e=>(e.uuid||e.telefone)===t?a:e))}else{const a=await e.json();alert(`Erro ao atualizar lead: ${a.error||"Erro desconhecido"}`)}}catch(n){alert(`Erro ao atualizar lead: ${n.message}`)}h(null),w(!1),g(null),N(null),y(null),A(null)},[u,L,k,V]),Z=e.useCallback(e=>t.filter(a=>(a.status||"novo")===e),[t]),P=e.useCallback(e=>{if(!e)return"Sem telefone";const a=e.replace(/\D/g,"");return 13===a.length?`+${a.slice(0,2)} (${a.slice(2,4)}) ${a.slice(4,9)}-${a.slice(9)}`:e},[]),O=e.useCallback(e=>{r(a=>[e,...a]),v(!1)},[]),_=e.useCallback(e=>{p(e),j(!0)},[]),q=e.useCallback(e=>{r(a=>a.map(a=>a.uuid===e.uuid?e:a)),j(!1),p(null)},[]),U=e.useCallback(e=>{r(a=>a.filter(a=>a.uuid!==e.uuid)),j(!1),p(null)},[]),J=e.useMemo(()=>{const e=t.length,a=t.filter(e=>["agendado","compareceu","servico_finalizado"].includes(e.status)).length,l=t.filter(e=>"fechado"===e.status).length;return{total:e,emAndamento:a,fechados:l,taxaConversao:e>0?(l/e*100).toFixed(1):"0.0"}},[t]);return d?a.jsxs("div",{className:"kanban-loading",children:[a.jsx("div",{className:"loading-spinner"}),a.jsx("p",{children:"Carregando leads..."})]}):a.jsxs("div",{className:"kanban-board",children:[a.jsxs("div",{className:"kanban-header",children:[a.jsx("h1",{children:"CRM - Kanban"}),a.jsxs("button",{className:"add-lead-button",onClick:()=>v(!0),children:[a.jsx("svg",{viewBox:"0 0 24 24",width:"20",height:"20",children:a.jsx("path",{fill:"currentColor",d:"M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"})}),"Adicionar Lead"]})]}),a.jsxs("div",{className:"stats-cards",children:[a.jsxs("div",{className:"stat-card",children:[a.jsx("div",{className:"stat-icon blue",children:a.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",children:a.jsx("path",{fill:"currentColor",d:"M16,13C15.71,13 15.38,13 15.03,13.05C16.19,13.89 17,15 17,16.5V19H23V16.5C23,14.17 18.33,13 16,13M8,13C5.67,13 1,14.17 1,16.5V19H15V16.5C15,14.17 10.33,13 8,13M8,11A3,3 0 0,0 11,8A3,3 0 0,0 8,5A3,3 0 0,0 5,8A3,3 0 0,0 8,11M16,11A3,3 0 0,0 19,8A3,3 0 0,0 16,5A3,3 0 0,0 13,8A3,3 0 0,0 16,11Z"})})}),a.jsxs("div",{className:"stat-content",children:[a.jsx("div",{className:"stat-label",children:"Total de Leads"}),a.jsx("div",{className:"stat-value",children:J.total})]})]}),a.jsxs("div",{className:"stat-card",children:[a.jsx("div",{className:"stat-icon yellow",children:a.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",children:a.jsx("path",{fill:"currentColor",d:"M13,2.05V5.08C16.39,5.57 19,8.47 19,12C19,12.9 18.82,13.75 18.5,14.54L21.12,16.07C21.68,14.83 22,13.45 22,12C22,6.82 18.05,2.55 13,2.05M12,19C8.13,19 5,15.87 5,12C5,8.47 7.61,5.57 11,5.08V2.05C5.94,2.55 2,6.81 2,12A10,10 0 0,0 12,22C15.3,22 18.23,20.39 20.05,17.91L17.45,16.38C16.17,18 14.21,19 12,19Z"})})}),a.jsxs("div",{className:"stat-content",children:[a.jsx("div",{className:"stat-label",children:"Em Andamento"}),a.jsx("div",{className:"stat-value",children:J.emAndamento})]})]}),a.jsxs("div",{className:"stat-card",children:[a.jsx("div",{className:"stat-icon green",children:a.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",children:a.jsx("path",{fill:"currentColor",d:"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"})})}),a.jsxs("div",{className:"stat-content",children:[a.jsx("div",{className:"stat-label",children:"Fechados"}),a.jsx("div",{className:"stat-value",children:J.fechados})]})]}),a.jsxs("div",{className:"stat-card",children:[a.jsx("div",{className:"stat-icon "+(parseFloat(J.taxaConversao)>0?"green":"red"),children:a.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",children:a.jsx("path",{fill:"currentColor",d:"M16,6L18.29,8.29L13.41,13.17L9.41,9.17L2,16.59L3.41,18L9.41,12L13.41,16L19.71,9.71L22,12V6H16Z"})})}),a.jsxs("div",{className:"stat-content",children:[a.jsx("div",{className:"stat-label",children:"Taxa de Conversão"}),a.jsxs("div",{className:"stat-value",children:[J.taxaConversao,"%"]})]})]})]}),a.jsx("div",{className:"kanban-columns",children:i.map(e=>{const l=Z(e.id);return a.jsxs("div",{className:"kanban-column","data-status":e.id,onDragOver:$,onDrop:a=>F(a,e.id),children:[a.jsxs("div",{className:"column-header",style:{borderTopColor:`var(${e.colorVar})`},children:[a.jsx("h3",{children:e.title}),a.jsx("span",{className:"column-count",children:l.length})]}),a.jsx("div",{className:"column-cards",children:0===l.length?a.jsx("div",{className:"empty-column",children:a.jsx("p",{children:"Nenhum lead"})}):l.map(e=>a.jsxs("div",{className:"lead-card "+((u?.uuid||u?.telefone)===(e.uuid||e.telefone)?"dragging":""),draggable:!0,onDragStart:a=>T(a,e),onTouchStart:a=>z(a,e),onTouchMove:D,onTouchEnd:B,onClick:()=>!L&&_(e),children:[a.jsxs("div",{className:"lead-card-header",children:[a.jsx("div",{className:"lead-name",children:e.nome||"Sem nome"}),e.trava&&a.jsxs("div",{className:"lead-badge paused",children:[a.jsx("svg",{viewBox:"0 0 24 24",width:"12",height:"12",children:a.jsx("path",{fill:"currentColor",d:"M14,19H18V5H14M6,19H10V5H6V19Z"})}),"Pausado"]})]}),a.jsxs("div",{className:"lead-phone",children:[a.jsx("svg",{viewBox:"0 0 24 24",width:"14",height:"14",children:a.jsx("path",{fill:"currentColor",d:"M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"})}),P(e.telefone)]}),e.email&&a.jsxs("div",{className:"lead-email",children:[a.jsx("svg",{viewBox:"0 0 24 24",width:"14",height:"14",children:a.jsx("path",{fill:"currentColor",d:"M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z"})}),e.email]}),e.observacoes&&""!==e.observacoes.trim()&&a.jsxs("div",{className:"lead-observacoes",children:[a.jsx("svg",{viewBox:"0 0 24 24",width:"14",height:"14",children:a.jsx("path",{fill:"currentColor",d:"M9,22A1,1 0 0,1 8,21V18H4A2,2 0 0,1 2,16V4C2,2.89 2.9,2 4,2H20A2,2 0 0,1 22,4V16A2,2 0 0,1 20,18H13.9L10.2,21.71C10,21.9 9.75,22 9.5,22V22H9M10,16V19.08L13.08,16H20V4H4V16H10Z"})}),e.observacoes]})]},e.uuid||e.telefone))})]},e.id)})}),m&&a.jsx(o,{onClose:()=>v(!1),onLeadCreated:O}),x&&f&&a.jsx(n,{lead:f,onClose:()=>{j(!1),p(null)},onLeadUpdated:q,onLeadDeleted:U})]})});export{r as default};
